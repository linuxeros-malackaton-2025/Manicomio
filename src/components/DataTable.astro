<script is:inline>
  window.addEventListener('sql-run', async (e) => {
    const sql = e.detail?.sql ?? '';
    const title = document.getElementById('queryTitle');
    const analysis = document.getElementById('queryAnalysis');
    const placeholder = document.getElementById('placeholder');
    const dataTable = document.getElementById('dataTable');
    const head = document.getElementById('tableHeadRow');
    const body = document.getElementById('tableBody');

    if (!placeholder || !dataTable || !head || !body || !title || !analysis) return;

    // Mostrar estado de carga
    placeholder.textContent = 'Consultando Oracle...';
    placeholder.style.display = 'block';
    dataTable.style.display = 'none';
    analysis.textContent = '';

    try {
      // Llamada REAL a Oracle
      const response = await fetch('/api/queryDB', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sql })
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Error en la consulta');
      }

      const data = result.rows;

      // Actualizar título
      title.textContent = `Resultados: ${data.length} registro(s)`;
      analysis.textContent = sql;

      if (data.length === 0) {
        placeholder.textContent = 'La consulta no devolvió resultados';
        placeholder.style.display = 'block';
        dataTable.style.display = 'none';
        return;
      }

      // Construir tabla
      head.innerHTML = Object.keys(data[0])
        .map(c => `<th>${c}</th>`)
        .join('');

      body.innerHTML = data
        .map(row => `<tr>${Object.values(row)
          .map(v => `<td>${v ?? 'NULL'}</td>`)
          .join('')}</tr>`)
        .join('');

      placeholder.style.display = 'none';
      dataTable.style.display = 'table';

    } catch (err) {
      placeholder.textContent = `Error: ${err.message}`;
      placeholder.style.display = 'block';
      dataTable.style.display = 'none';
    }
  });
</script>